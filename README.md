# CRM

Небольшой пример CRM системы для взаимодействия системного администратора с клиентами, которых он обслуживает. Приложение построено на Flask и SQLite и предоставляет простой REST API для управления клиентами, активами, договорами и тикетами поддержки.

## Возможности

- управление клиентами (создание, обновление, удаление, заметки);
- учет оборудования и других активов клиента;
- хранение договоров обслуживания с датами действия и уровнем поддержки;
- ведение тикетов поддержки с приоритетами, ответственными и заметками инженеров;
- обзорная панель с ключевыми показателями загрузки;
- клиентский обзор с быстрым доступом ко всем активам, договорам, заметкам и тикетам;
- задачи по клиентам с отслеживанием статуса, приоритета и исполнителей;
- планирование технических визитов и встреч с календарём назначений;
- справочник компаний, к которым относятся клиенты, с привязкой через выпадающий список;
- переключение темы интерфейса (светлая/темная) для клиентов и пользователей через REST;
- двухэтапная аутентификация (TOTP) и базовые операции управления пользователями;
- автоматическое создание тикетов по событиям мониторинга (например, Zabbix) и трекинг инцидентов;
- встроенная база знаний с фильтрами по публикациям и привязкой к клиентам;
- прогнозирование риска оттока и загрузки инженеров на основе оперативных данных;
- оптимизация расписания выездов с учётом буферов на дорогу и рабочего дня.

## Быстрый старт

```bash
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
flask --app app:create_app init-db
flask --app app:create_app seed-db  # заполнение демонстрационными данными
flask --app app:create_app run
```

По умолчанию база данных создаётся в файле `crm.sqlite` в корневой директории проекта. Параметр `CRM_DATABASE_URL` позволяет переопределить путь к базе.



## Сборка исполняемого файла

Для развёртывания CRM как автономного Windows-исполняемого файла используйте PyInstaller. Скрипт `build_exe.py` инкапсулирует необходимые параметры и позволяет собрать один файл `crm.exe`.

```bash
python -m venv .venv
source .venv/bin/activate  # или .venv\Scripts\activate в Windows
pip install -r requirements.txt
pip install -r requirements-build.txt
python build_exe.py
```

Готовый исполняемый файл появится в директории `dist/`. При необходимости можно задать собственное имя файла или передать дополнительные флаги PyInstaller:

```bash
python build_exe.py --name my-crm -- --windowed
```

Флаг `--no-clean` оставит промежуточные артефакты сборки, что помогает анализировать содержимое при отладке пакета.

## Основные эндпоинты

| Метод | URL | Описание |
|-------|-----|----------|
| GET   | `/health` | Проверка доступности сервиса |
| GET   | `/api/clients` | Список клиентов |
| POST  | `/api/clients` | Создание клиента |
| GET   | `/api/clients/<id>` | Получение клиента |
| PUT   | `/api/clients/<id>` | Обновление данных клиента |
| DELETE| `/api/clients/<id>` | Удаление клиента |
| GET   | `/api/clients/<id>/assets` | Список активов клиента |
| POST  | `/api/clients/<id>/assets` | Добавление актива клиенту |
| GET   | `/api/clients/<id>/contracts` | Список договоров клиента |
| POST  | `/api/clients/<id>/contracts` | Добавление договора обслуживания |
| GET   | `/api/clients/<id>/notes` | Список заметок о клиенте |
| POST  | `/api/clients/<id>/notes` | Добавление заметки о клиенте |
| GET   | `/api/clients/<id>/tickets` | Тикеты конкретного клиента |
| GET   | `/api/clients/<id>/overview` | Обзор клиента с метриками, задачами и активностью |
| GET   | `/api/clients/<id>/tasks` | Список задач клиента |
| POST  | `/api/clients/<id>/tasks` | Создание задачи для клиента |
| PUT   | `/api/clients/<id>/theme` | Сохранение предпочтений по теме для карточки клиента |
| GET   | `/api/clients/<id>/appointments` | Список назначенных визитов клиента |
| POST  | `/api/clients/<id>/appointments` | Создание визита/встречи с клиентом |
| POST  | `/api/tickets` | Создание тикета |
| GET   | `/api/tickets` | Список тикетов (опционально фильтр по `status`) |
| PUT   | `/api/tickets/<id>` | Обновление тикета |
| POST  | `/api/tickets/<id>/notes` | Добавление заметки к тикету |
| GET   | `/api/dashboard/overview` | Обзор ключевых метрик |
| GET   | `/api/analytics/forecasts` | Прогнозы оттока клиентов и загрузки инженеров |
| GET   | `/api/tasks` | Глобальный список задач (опционально фильтр по `status`) |
| PUT   | `/api/tasks/<id>` | Обновление задачи |
| POST  | `/api/tasks/<id>/complete` | Завершение задачи |
| GET   | `/api/appointments` | Глобальный список визитов с фильтрами по статусу и датам |
| PUT   | `/api/appointments/<id>` | Обновление визита/перенос или завершение |
| DELETE| `/api/appointments/<id>` | Удаление визита |
| POST  | `/api/schedule/optimize` | Расчёт оптимизированного расписания на дату |
| GET   | `/api/companies` | Справочник компаний |
| POST  | `/api/companies` | Добавление компании |
| PUT   | `/api/companies/<id>` | Обновление компании |
| DELETE| `/api/companies/<id>` | Удаление компании |
| POST  | `/api/integrations/zabbix/events` | Приём события мониторинга и создание тикета |
| GET   | `/api/monitoring/incidents` | Список мониторинговых инцидентов |
| PATCH | `/api/monitoring/incidents/<id>` | Обновление статуса или привязки инцидента |
| GET   | `/api/knowledge-base` | Публикации базы знаний (фильтры по клиенту/статусу) |
| POST  | `/api/knowledge-base` | Создание статьи базы знаний |
| GET   | `/api/knowledge-base/<id>` | Получение статьи |
| PUT   | `/api/knowledge-base/<id>` | Обновление статьи |
| DELETE| `/api/knowledge-base/<id>` | Удаление статьи |
| POST  | `/api/auth/register` | Регистрация пользователя |
| POST  | `/api/auth/login` | Логин пользователя с поддержкой 2FA |
| POST  | `/api/auth/two-factor/setup` | Генерация секрета и ссылки для подключения 2FA |
| POST  | `/api/auth/two-factor/verify` | Подтверждение включения 2FA |
| POST  | `/api/auth/two-factor/disable` | Отключение 2FA |
| PUT   | `/api/users/<id>/theme` | Сохранение темы для пользователя |

## Структура проекта

- `app/__init__.py` — фабрика Flask-приложения и CLI-команды.
- `app/database.py` — инициализация базы данных.
- `app/models.py` — SQLAlchemy-модели CRM.
- `app/routes.py` — реализации REST эндпоинтов.
- `app/seed.py` — заполнение демонстрационными данными.
- `main.py` — точка входа для запуска dev-сервера.

### Дистанционное подключение

При установке CRM на рабочую станцию техника доступна CLI-команда `flask --app app:create_app sync-anydesk-id <client_id>`,
которая выполнит проверку наличия AnyDesk, попытается установить его (при возможности) и синхронизирует ID рабочего стола
с карточкой клиента. Если AnyDesk уже установлен, ID будет считан через CLI приложения.

Для получения информации о дистанционном доступе из внешних систем добавлены эндпоинты:

| Метод | URL | Описание |
|-------|-----|----------|
| GET   | `/api/clients/<id>/remote-access` | Возвращает текущий инструмент и ID удалённого рабочего стола |
| POST  | `/api/clients/<id>/remote-access/sync` | Запускает попытку установки AnyDesk и обновления ID на машине клиента |

### Задачи и SLA-фокус

- хранение задач в разрезе клиентов с отслеживанием статуса (`pending`, `in_progress`, `completed`) и приоритета;
- завершение задач отдельным эндпоинтом, который фиксирует время закрытия;
- включение задач и связанных метрик в обзор клиента и дашборд, чтобы быстро видеть загруженность команды.

### Переключение тем интерфейса

- клиенты и пользователи могут хранить персональное предпочтение темы (`light` / `dark`);
- настройки темы выставляются через простые REST-запросы и могут использоваться фронтендом для включения тёмной темы.

### Справочник компаний

- отдельная сущность `Company` c базовой информацией, на которую ссылаются клиенты;
- клиенты выбирают компанию из справочника (или сохраняют временное текстовое значение для совместимости);
- возможность управлять компаниями через стандартные CRUD-эндпоинты.

### Двухэтапная аутентификация

- управление пользователями с хешированием паролей и хранением предпочтений по теме;
- включение TOTP 2FA в два шага: генерация секрета и подтверждение одноразовым кодом;
- проверка одноразового кода при логине и возможность отключить 2FA при необходимости.

### Планирование визитов и встреч

- новая сущность `Appointment` хранит время начала, длительность, статус и исполнителя визита;
- клиентский обзор показывает ближайший визит, общие показатели по расписанию и полную ленту назначений;
- глобальные и клиентские эндпоинты поддерживают фильтрацию по статусу (`scheduled`, `completed`, `cancelled`) и диапазонам дат;
- демонстрационные данные включают предстоящий выезд и завершённую стратегическую встречу.

### Интеграция с мониторингом

- REST-вход `/api/integrations/zabbix/events` принимает события от Zabbix, автоматически заводит тикеты и сохраняет инциденты;
- список `/api/monitoring/incidents` позволяет отслеживать открытые проблемы и связывать их с тикетами;
- в обзоре клиента отображаются последние пять инцидентов и счётчик незакрытых событий.

### База знаний и самообслуживание

- сущность `KnowledgeBaseArticle` хранит инструкции, чек-листы и регламенты с метаданными;
- статьи можно фильтровать по клиенту, публикации и тегам, обновлять или архивировать через REST;
- карточка клиента показывает релевантные опубликованные статьи для быстрого доступа инженеров и заказчика.

### Прогнозная аналитика

- эндпоинт `/api/analytics/forecasts` вычисляет вероятность оттока и предлагает рекомендации по каждому клиенту;
- расчёты учитывают открытые тикеты, просроченные задачи, отменённые визиты и мониторинговые инциденты;
- дашборд и обзор клиента включают показатели загрузки инженеров и риск-скор.

### Оптимизация расписания

- сервис `/api/schedule/optimize` анализирует визиты на выбранную дату, учитывает буфер на дорогу и длительность смены;
- алгоритм устраняет пересечения, перераспределяет не назначенные выезды и подсвечивает перегруженные участки;
- результат содержит оптимизированные интервалы и рекомендации по назначению инженеров.

## Тестирование API

Пример создания нового тикета:

```bash
curl -X POST http://localhost:5000/api/tickets \
  -H "Content-Type: application/json" \
  -d '{
    "client_id": 1,
    "subject": "Настройка нового сервера",
    "priority": "high",
    "assigned_to": "Иван",
    "due_date": "2024-09-01"
  }'
```

Пример включения двухэтапной аутентификации для зарегистрированного пользователя:

```bash
curl -X POST http://localhost:5000/api/auth/two-factor/setup \
  -H "Content-Type: application/json" \
  -d '{"user_id": 1, "password": "adminpass"}'

# после сканирования QR-кода в приложении генерации OTP
curl -X POST http://localhost:5000/api/auth/two-factor/verify \
  -H "Content-Type: application/json" \
  -d '{"user_id": 1, "otp": "123456"}'
```

## Развитие

- интеграция разграничения прав доступа и ролевой модели администратор/инженер/клиент;
- уведомления по электронной почте или мессенджерам при смене статусов тикетов и задач;
- автоматизация напоминаний о визитах и интеграция с корпоративными календарями;
- фронтенд интерфейс на любом современном фреймворке с использованием REST и переключения тем;
- автоматическое формирование отчётов по SLA и загрузке команды.

## Интересные идеи из других CRM

- **Автоматизация продаж и сервиса** — конструктор автоматических сценариев (например, HubSpot) помогает ускорять follow-up и напоминания клиентам.
- **Встроенная база знаний** — такие решения, как Zoho CRM, предлагают централизованную базу знаний для техподдержки и самообслуживания клиентов.
- **Аналитика с прогнозами** — AI-подсказки, встречающиеся в Salesforce, позволяют прогнозировать отток клиентов и планировать загрузку инженеров.
- **Порталы самообслуживания** — клиентские порталы (Freshdesk) дают возможность самим создавать тикеты, отслеживать их статус и видеть историю активов.
- **Интеграции с мониторингом** — связка с системами мониторинга инфраструктуры (например, Zabbix или PRTG) для автоматического создания тикетов при инцидентах.
- **Оптимизация расписания** — сервисы уровня ServiceM8 или FieldAware помогают подбирать время и маршруты выездов, автоматически учитывая занятость инженеров.
- **Цифровые ассистенты** — решения вроде Einstein GPT (Salesforce) или Zoho Zia помогают предлагать следующее лучшее действие, автоматизировать ответы и дополняют прогнозы.
